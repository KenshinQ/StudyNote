### 							UnityShader入门

##### Unity渲染路径

​	UnityShader中的Pass一般都需要指定光照渲染路径标签，如果一个Pass中没有指定任何渲染路径的标签，则会被当成一个使用顶点照明渲染路径的Pass。Pass中的光照渲染路径标签是用来告诉Unity底层渲染引擎该Pass使用的是什么光照渲染路径，需要底层渲染引擎准备好相应的光照属性，以便接下来使用。如果没有指定正确的光照渲染路径标签，系统内置的光照变量可能不会被正确赋值。

######前向渲染

​	Unity中前向渲染路径有3种处理光照的方式：逐顶点处理、逐像素处理和球谐函数处理。决定一个光源使用哪中处理光照方式的是光源的类型和光源的渲染模式。在光源的光照组件可以设置光源类型和渲染模式。除了最亮的平行光总是按逐像素处理之外，默认情况下最多自动会有N个逐像素处理的光源，这个N在Quality Setting中设置。Unity判断光源应该使用的光照处理方式的规则是：

- 场景中最亮的平行光总是按逐像素处理

- 渲染模式被设置成Not Important的光源，会按逐顶点或者SH(球谐函数)方式处理。不过，最多有4个光源按逐顶点的方式处理

- 渲染模式被设置成Important的光源，会按逐像素处理。

- 如果根据以上规则得到的逐像素光源小于Quality Setting中设置的逐像素光源数量，Unity会选择某些剩下的光源以逐像素的方式进行处理。

  Unity中前向渲染有两种Pass:Base Pass和Additional Pass，对应两种光照渲染路径标签。一个Unity Shader通常会定义一个Base Pass和一个Additional Pass，一个Base Pass只会执行一次（但是定义多个Base Pass除外，例如双面渲染），Additional Pass执行的次数由影响物体的其他逐像素光源数目决定。

  - Base Pass，使用的光照渲染路径标签是FowardBase。Base Pass中进行一个逐像素平行光以及所有逐顶点和球谐光源光照计算。在这个Pass中可以访问Lightmap(光照贴图)，同时在这个Pass中进行环境光和自发光的计算。因为环境光和自发光计算一次就可以了，如果放在Additional Pass中会导致多次环境光和自发光的叠加。
  - Additional Pass，使用的光照渲染路径标签是ForwardAdd。其他影响物体的每个逐像素光源都会执行一次这个Pass。默认情况下，这个Pass中是没有阴影效果的，但可以通过使用#pragma multi_complie_fwdadd_fullshadows编译指令来使得它可以为点光源和聚光灯源提供阴影效果。在这个Pass中还需要设置混合模式，这是因为，我们希望每一次Additional Pass的渲染可以和上一次的光照结果在帧缓存中进行叠加，从而得到有多个光照的渲染效果。而如果没有开启和设置混合模式，则每一Additional Pass的渲染的结果会覆盖掉之前的渲染结果，使得该物体看起来只受一个光源的影响。一般使用的混合模式是Blend One One。

  自定义Unity Shader完全可以在自己写Base Pass和Additional Pass中进行逐顶点的光照计算。

  在Additional Pass中处理逐像素光源的光照衰减，平行光是没有衰减的，主要是点光源和聚光灯源，Unity提供一张纹理来查找光照的衰减，而不依赖于复杂的数学公式计算，这样的好处是效率更高。我们可以用光源空间中相应位置的坐标的摸平方来对Unity提供的衰减纹理进行采样，从而得到衰减值。

##### 延迟渲染

​	延迟渲染的原理是，延迟渲染包含两个Pass，在第一个Pass中不进行光照计算，而是计算哪些片元可见，如果片元可见则把它相关的信息写入G缓冲区中；然后在第二个Pass中，利用G缓冲区中的信息进行光照计算。这样渲染一个物体通常就用到两个Pass，跟场景中的光源数量没有关系。也就是说，延迟渲染的效率和场景的复杂度没有关系，而和屏幕空间的大小有关系，因为我们需要的信息都存在缓冲区中，而缓冲区可以看成是一张张2D图像，光照计算实际上是在这些图像空间中进行的。

##### Unity阴影的实现

​	Unity在实现阴影效果，使用的是一种shadowmap（阴影映射纹理）技术。简单来说，这种技术是把摄像机移动到光源的位置，那么场景中该光源的阴影区域就是摄像机看不到的地方，这些信息会被记录在阴影映射纹理（shadowmap）中，这张阴影映射纹理本质上是一张深度图，它记录了从光源位置出发能看到场景中距离它最近的表面的深度信息。光源开启了阴影效果，Unity就会为它计算生成阴影映射纹理，生成阴影映射纹理的过程是，Unity底层渲染引擎会在要渲染物体的Unity Shader中查找LightMode设置为ShadowCaster的Pass,如果没找到，它会在Fallback中指定的shader中继续查找，如果最终没有找到，那么这个物体将不能产生阴影，当找到了这个Pass之后，Unity先把摄像机放置在光源的位置上，然后调用该Pass,通过对顶点变换后得到光源空间下的位置，并据此来输出深度信息到阴影映射纹理中。一个物体接收来自其他物体的阴影，以及向其他物体投射阴影是两个过程。

- 如果我们要一个物体向其他物体投射阴影，就必须把该物体加入到阴影投射纹理的计算中，从而让其他物体对阴影映射纹理进行采样时可以得到该物体相关的信息。Unity中，这个过程通过对该物体执行LightMode为ShadowCaster的Pass来实现。
- 如果我们要一个物体接收赖子其他物体投射的阴影，就必须在Shader中对阴影映射纹理进行采样，把采样结果和最后的光照结果相乘来产生阴影效果。