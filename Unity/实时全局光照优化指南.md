### 实时全局光照优化指南

​	Unity中全局光照技术有两种，一种是Realtime-GI（实时全局光照），一种是Baked GI（烘培全局光照）。当启用烘培全局光照时，预计算阶段计算产生的是传统的光照贴图，它包含了间接光照的光影效果，也可能会包含直接光照的阴影效果，这些光照贴图分辨率都比较高，因为运行时将直接由这些光照贴图得到间接光照的光影效果。当启用Realtime-GI时，预计算阶段将计算照射到静态对象上所有可能的光反射路径，然后把这些信息保存在Lighting Data Asset中，运行时根据这个光照数据文件（Lighting Data Asset）实时产生一组低分辨率的光照贴图。

​	在进行Realtime-GI的预计算时，如果未进行优化，整个预计算过程可能要消耗很长时间。接下来将学习如何针对Enlight系统来优化场景，让预计算阶段所需要的时间只需几分钟而非几小时。

优化的过程将从多个方面来进行，包括：

* 如何定义一个适合场景的光照实时分辨率
* 什么是光照图（Charts），它任何影响到计算的时间
* 如何开始一个预计算
* 使用光照探针来降低光照方案的复杂度
* 改进Unity  precomputed realtime-GI的自动拆解的UV结果
* 何谓丛集，如何用它来产生GI照明
* 以对象为基础使用光照贴图参数来微调光照

### 优化内容一:光照实时分辨率

​	在使用全局光照技术时，首先要决定的就是场景的实时分辨率，它决定了每个世界单位（world unit）所使用光照贴图的像素数量。可以在Windows->Lighting光照设置中调整实时分辨率的值。

​	在设定场景时，首先要明确的是项目需要的单位比例，即项目场景中一个世界单位相当于现实世界的尺寸，Unity没有默认规定世界单位对应现实世界的尺寸值，由开发者自行决定。通常我们设置一个world unit相当于现实世界1米，因为如果这样的话可以很好的和Unity的物理概念匹配，比如Unity的重力预设是每秒多少单位，于是当1 world unit=1米时可以很好的模拟真实世界的设定。

​	实时分辨率（Realtime Resolution）的值根据游戏的规模来制定，如果是小小的却拥有丰富光照变化的室内场景，实时分辨率应该设的高一点如2-3 texel/unit，这样可以捕捉到更详细的光照。如果场景是一个世界规模较大的大型户外场景，里面可能有几千或几百个几乎不会去修改光照反射的对象，实时分辨率应该设的低一点，在场景里有大对象的室外环境，实时分辨率可以设定在0.5-1 texel/unit之间，针对地形可以设定0.1-0.5 texl/unit之间。

​	Realtime-GI预计算所需要的实时分辨率比Baked GI预计算所需要的实时分辨率要低好几个等级，因为Realtime GI只从预计算生成的光照图中获取间接光照数据，这些数据通常分辨率都比较低。于是，在1 world unit =1米的设定下，Realtime GI有一些常用的实时分辨率设置：

* 室内----2-3像素/单位
* 室外----0.5-1像素/单位
* 地形----0.1-0.5像素/单位

除了给场景设定实时分辨率之外，我们还能通过光照贴图参数来调整特定对象的光照贴图的分辨率，在需要高分辨率来提供更高真实感的时候，可以选择性的提高这个值。通常将场景里最多的对象分辨率设为默认值，然后手动调高需要更多照明细节的对象的分辨率。

### 优化内容二：光照图

​	光照图对应场景内静态对象某一区域的光照贴图uv坐标。光照贴图的uv纹理坐标被包含在光照图之内，光照图会比光照贴图uv多出半个单位的像素，这样可以防止贴图过滤造成的渗色。一张光照图包含两部分信息：辐照度和方向性（光线方向编码）。在precomputed realtime GI进行计算时，光照图中的每个像素都会被计算光照。所以，当场景内对象会产生大量光照图的时候，会使Precomputed Realtime GI计算消耗大量的时间。

​	默认情况下，每个光照图最小是4X4单位像素大小。所以，无论场景内对象有多小或者对应的uv纹理有多小，光照图都至少要16个单位的像素。例如，如果有一个对象是1X1单位大小，这个对象有一个光照图，此时的光照分辨率是1，但是这个对象的光照图还是要16个像素。光照图的最小尺寸设定，使得Unity能够将对象几何边界处的光照图无缝的缝合起来，Unity要求光照图的边缘至少有4个单位像素，才能唯一的找到一个光照图对应的另一个匹配光照图来缝合。

​	如果光照图的数量太多的话，将导致像素量急剧增加，而更多的像素量就意味着更多的光照计算，也就意味着更多的数据数据需要计算、压缩、存储。当这种情况出现在复杂的场景中，将导致预计算的时间变的很长，同时还会使得游戏运行时的性能降低。所以，不恰当的光照图数量是使得预计算时间过长甚至无法完成的主要原因。所以，我们减少预计算时间的策略主要还是以减少光照图数量为方向。